<app-navbar></app-navbar>
<div class="checkout-container">
  <div class="left">
    <h3>ที่อยู่สำหรับจัดส่ง</h3>
    <div class="address-card">
      <div *ngIf="!editingAddress">
        <p>{{ addressObj.line1 || '-' }}</p>
        <p *ngIf="addressObj.line2">{{ addressObj.line2 }}</p>
        <p *ngIf="addressObj.city">{{ addressObj.city }} {{ addressObj.postcode }}</p>
        <p *ngIf="addressObj.phone">เบอร์โทรศัพท์: {{ addressObj.phone }}</p>
        <!-- Thai formatted single-line address for convenience -->
        <p *ngIf="thaiAddress"><strong>ที่อยู่ (ภาษาไทย):</strong> {{ thaiAddress }}</p>
        <div class="address-actions">
          <button (click)="editAddress()">แก้ไขที่อยู่</button>
        </div>
      </div>
      <div *ngIf="editingAddress" class="address-form">
        <label>ที่อยู่ (บรรทัด 1)
          <input [(ngModel)]="addressObj.line1" />
        </label>
        <label>บรรทัด 2
          <input [(ngModel)]="addressObj.line2" />
        </label>
        <label>จังหวัด/อำเภอ
          <input [(ngModel)]="addressObj.city" />
        </label>
        <label>รหัสไปรษณีย์
          <input [(ngModel)]="addressObj.postcode" />
        </label>
        <label>เบอร์โทร
          <input [(ngModel)]="addressObj.phone" />
        </label>
        <div class="address-actions">
          <button (click)="saveAddress()">บันทึกที่อยู่</button>
        </div>
      </div>
    </div>

    <h3>ช่องทางการชำระเงิน</h3>
      <div class="payment-options">
      <label><input type="radio" name="pay" [(ngModel)]="paymentMethod" (ngModelChange)="onSelectPayment($event)" value="bank_transfer" /> โอนเงินธนาคาร</label>
      <label><input type="radio" name="pay" [(ngModel)]="paymentMethod" (ngModelChange)="onSelectPayment($event)" value="cod" /> ชำระเงินปลายทาง</label>
      <label><input type="radio" name="pay" [(ngModel)]="paymentMethod" (ngModelChange)="onSelectPayment($event)" value="qr" /> สแกน QR</label>
    </div>
    <div *ngIf="paymentMethod === 'qr'" class="qr-code">
      <p>สแกนเพื่อชำระเงิน</p>
      <div class="qr-preview">
        <img *ngIf="qrUrl" [src]="qrUrl" alt="QR Payment" />
        <div *ngIf="!qrUrl">กำลังสร้าง QR...</div>
      </div>
    </div>
  </div>

  <div class="right">
    <h3>สรุปคำสั่งซื้อ</h3>
    <div class="order-summary">
      <div class="item" *ngFor="let it of items">
        <div class="thumb">{{ it.product.image }}</div>
        <div class="meta">
          <div class="name">{{ it.product.name }}</div>
          <div *ngIf="it.product.sizes?.length" class="size-select">
            <label>ขนาด</label>
            <select [(ngModel)]="it.size" (ngModelChange)="updateSizeFor(it, $event)">
              <option *ngFor="let s of it.product.sizes" [value]="s">{{ s }}</option>
            </select>
          </div>
          <div class="qty-control">
            <label>จำนวน</label>
            <div class="qty-controls">
              <input type="number" [(ngModel)]="it.quantity" min="1" step="1" inputmode="numeric" (ngModelChange)="updateQuantityFor(it, $event)" />
            </div>
          </div>
        </div>
        <div class="price">฿{{ (it.product.price * (it.quantity || 1)).toFixed(2) }}</div>
      </div>

      <div class="summary-line"><span>ยอดรวมย่อย</span><span>฿{{ subtotal.toFixed(2) }}</span></div>
      <div class="summary-line"><span>ค่าธรรมเนียม</span><span>฿{{ marketplaceFee.toFixed(2) }}</span></div>
      <div class="summary-total"><span>ยอดที่ต้องชำระ</span><span>฿{{ total.toFixed(2) }}</span></div>

      <div class="actions">
        <button class="place-order" (click)="confirmOrder()">ยืนยันการสั่งซื้อ</button>
      </div>
    </div>
  </div>
</div>
